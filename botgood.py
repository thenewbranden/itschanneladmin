import requests
import time
import schedule
from telegram import Bot
from datetime import datetime, timedelta

# اطلاعات ربات و کانال‌ها
TOKEN = 'توکن_ربات_خودت'
CHANNEL_IDS = ['@OghabCrypto', '@Trademr2', '@IRcryptoLab']  # آیدی کانال‌ها

bot = Bot(token=TOKEN)

# API Cloudy
CLOUDY_API_KEY = "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"
CLOUDY_URL = "https://openrouter.ai/api/v1/chat/completions"

HEADERS = {
    "Authorization": f"Bearer {CLOUDY_API_KEY}",
    "Content-Type": "application/json"
}

# مدل‌های جایگزین
MODELS = [
    "perplexity/cloudy-600b-instruct",
    "mistralai/mixtral-8x7b-instruct",
    "meta-llama/llama-3-70b-instruct"
]

# تابع گرفتن پیام با سه راه مختلف
def get_message(prompts):
    for i in range(3):
        model = MODELS[i]
        prompt = prompts[i]
        data = {
            "model": model,
            "messages": [
                {"role": "user", "content": prompt}
            ]
        }
        try:
            response = requests.post(CLOUDY_URL, headers=HEADERS, json=data, timeout=60)
            response.raise_for_status()
            content = response.json()['choices'][0]['message']['content']
            if content and len(content.strip()) > 10:
                return content
        except Exception as e:
            print(f"Error in way {i+1} for model {model}: {e}")
    return "متاسفانه فعلاً امکان دریافت پیام وجود ندارد."

# پیام سلام و روز بخیر (برای هر کانال یک پرامپت خاص)
def send_good_morning():
    prompts_list = [
        [
            "سلام و صبح بخیر به اعضای عزیز کانال! امروز با انرژی و انگیزه شروع کنید و با ری‌اکشن حضور خودتون رو نشون بدید. آماده یک روز عالی باشید!",
            "یک پیام صبح بخیر و انرژی مثبت برای تریدرهای عزیز کانال بنویس و ازشون بخواه با ری‌اکشن آماده فعالیت روزانه باشن.",
            "صبح بخیر! امروز قراره با هم موفقیت‌های جدیدی رو تجربه کنیم. با ری‌اکشن نشون بدید که آماده‌اید!"
        ],
        [
            "سلام دوستان! یک روز جدید و پر از فرصت‌های تازه شروع شده. با ری‌اکشن حضور خودتون رو اعلام کنید و آماده ترید باشید.",
            "صبح بخیر به همه اعضای پرتلاش کانال! با ری‌اکشن نشون بدید که آماده یک روز پرانرژی هستید.",
            "یک پیام صبح بخیر و خوش‌آمدگویی برای اعضای کانال ترید بنویس و ازشون بخواه با ری‌اکشن حضورشون رو نشون بدن."
        ],
        [
            "صبح بخیر تریدرهای عزیز! امروز هم با هم برای موفقیت تلاش می‌کنیم. با ری‌اکشن حضور خودتون رو اعلام کنید.",
            "یک پیام انگیزشی صبحگاهی برای اعضای کانال ترید بنویس و ازشون بخواه با ری‌اکشن آماده شروع روز جدید باشن.",
            "سلام و صبح بخیر! آماده‌اید برای یک روز پر از سود و یادگیری؟ با ری‌اکشن حضور خودتون رو نشون بدید."
        ]
    ]
    for i, channel_id in enumerate(CHANNEL_IDS):
        message = get_message(prompts_list[i])
        bot.send_message(chat_id=channel_id, text=message)
    print("پیام سلام و روز بخیر ارسال شد.")

# اخبار کریپتو (برای هر کانال یک پرامپت خاص)
def send_crypto_news():
    prompts_list = [
        [
            "سه خبر مهم امروز بازار کریپتو و ترید را به زبان فارسی و خلاصه برای اعضای کانال بنویس.",
            "مهم‌ترین رویدادهای امروز بازار ارز دیجیتال را به زبان فارسی و خلاصه بنویس.",
            "امروز در بازار کریپتو چه خبر بوده؟ سه نکته مهم و خلاصه به زبان فارسی بنویس."
        ],
        [
            "دو خبر مهم و تاثیرگذار امروز بازار کریپتو را به زبان فارسی و خلاصه برای اعضای کانال بنویس.",
            "امروز چه اتفاقات مهمی در بازار ارز دیجیتال افتاده؟ به زبان فارسی و خلاصه توضیح بده.",
            "مهم‌ترین اخبار امروز بازار کریپتو را به زبان فارسی و خلاصه بنویس."
        ],
        [
            "یک خبر مهم و یک تحلیل کوتاه از وضعیت امروز بازار کریپتو به زبان فارسی بنویس.",
            "امروز بازار کریپتو چه روندی داشته؟ یک خبر و یک نکته مهم به زبان فارسی بنویس.",
            "خلاصه‌ای از اخبار مهم امروز بازار ارز دیجیتال به زبان فارسی بنویس."
        ]
    ]
    for i, channel_id in enumerate(CHANNEL_IDS):
        message = get_message(prompts_list[i])
        bot.send_message(chat_id=channel_id, text=message)
    print("اخبار کریپتو ارسال شد.")

# اخبار دنیا (برای هر کانال یک پرامپت خاص)
def send_world_news():
    prompts_list = [
        [
            "سه خبر مهم امروز دنیا را به زبان فارسی و خلاصه برای اعضای کانال بنویس.",
            "مهم‌ترین رویدادهای امروز جهان را به زبان فارسی و خلاصه بنویس.",
            "امروز در دنیا چه خبر بوده؟ سه نکته مهم و خلاصه به زبان فارسی بنویس."
        ],
        [
            "دو خبر مهم و تاثیرگذار امروز دنیا را به زبان فارسی و خلاصه برای اعضای کانال بنویس.",
            "امروز چه اتفاقات مهمی در دنیا افتاده؟ به زبان فارسی و خلاصه توضیح بده.",
            "مهم‌ترین اخبار امروز جهان را به زبان فارسی و خلاصه بنویس."
        ],
        [
            "یک خبر مهم و یک تحلیل کوتاه از وضعیت امروز دنیا به زبان فارسی بنویس.",
            "امروز دنیا چه روندی داشته؟ یک خبر و یک نکته مهم به زبان فارسی بنویس.",
            "خلاصه‌ای از اخبار مهم امروز جهان به زبان فارسی بنویس."
        ]
    ]
    for i, channel_id in enumerate(CHANNEL_IDS):
        message = get_message(prompts_list[i])
        bot.send_message(chat_id=channel_id, text=message)
    print("اخبار دنیا ارسال شد.")

# تحلیل بیتکوین (برای هر کانال یک پرامپت خاص)
def send_btc_analysis():
    prompts_list = [
        [
            "یک تحلیل کوتاه و معتبر از وضعیت امروز بیتکوین از منابع معتبر به زبان فارسی بنویس.",
            "امروز بیتکوین چه وضعیتی دارد؟ یک تحلیل کوتاه و خلاصه به زبان فارسی بنویس.",
            "تحلیل امروز بیتکوین را به زبان فارسی و خلاصه برای اعضای کانال بنویس."
        ],
        [
            "دو نکته مهم و تحلیلی درباره وضعیت امروز بیتکوین به زبان فارسی بنویس.",
            "امروز چه اتفاقات مهمی برای بیتکوین افتاده؟ به زبان فارسی و خلاصه توضیح بده.",
            "مهم‌ترین تحلیل امروز بیتکوین را به زبان فارسی و خلاصه بنویس."
        ],
        [
            "یک خبر مهم و یک تحلیل کوتاه از وضعیت امروز بیتکوین به زبان فارسی بنویس.",
            "امروز بیتکوین چه روندی داشته؟ یک خبر و یک نکته مهم به زبان فارسی بنویس.",
            "خلاصه‌ای از تحلیل‌های مهم امروز بیتکوین به زبان فارسی بنویس."
        ]
    ]
    for i, channel_id in enumerate(CHANNEL_IDS):
        message = get_message(prompts_list[i])
        bot.send_message(chat_id=channel_id, text=message)
    print("تحلیل بیتکوین ارسال شد.")

# پیام انگیزشی/آموزشی (برای هر کانال یک پرامپت خاص)
def send_educational_message():
    prompts_list = [
        [
            "یک متن آموزشی و انگیزشی خاص برای تریدرها به زبان فارسی بنویس.",
            "یک جمله انگیزشی و نکته روانشناسی برای موفقیت در ترید به زبان فارسی بنویس.",
            "یک نکته آموزشی و الهام‌بخش برای تریدرها به زبان فارسی بنویس."
        ],
        [
            "یک پیام انگیزشی و آموزشی برای تریدرها به زبان فارسی بنویس.",
            "یک جمله الهام‌بخش و نکته روانشناسی برای تریدرها به زبان فارسی بنویس.",
            "یک نکته آموزشی و انگیزشی برای موفقیت در ترید به زبان فارسی بنویس."
        ],
        [
            "یک پیام آموزشی و انگیزشی متفاوت برای تریدرها به زبان فارسی بنویس.",
            "یک جمله انگیزشی و نکته روانشناسی برای تریدرهای موفق به زبان فارسی بنویس.",
            "یک نکته آموزشی و الهام‌بخش برای تریدرهای حرفه‌ای به زبان فارسی بنویس."
        ]
    ]
    for i, channel_id in enumerate(CHANNEL_IDS):
        message = get_message(prompts_list[i])
        bot.send_message(chat_id=channel_id, text=message)
    print("پیام انگیزشی/آموزشی ارسال شد.")

# زمان‌بندی
if __name__ == '__main__':
    print("ربات Cloudy فعال شد...")

    # پیام سلام و روز بخیر هر روز ساعت 11:50 ایران (08:20 UTC)
    schedule.every().day.at("08:20").do(send_good_morning)  # 11:50 ایران = 08:20 UTC

    # اخبار ظهر هر روز ساعت 12:00 ایران (08:30 UTC)
    schedule.every().day.at("08:30").do(send_crypto_news)  # اخبار کریپتو
    schedule.every().day.at("08:31").do(send_world_news)   # اخبار دنیا (1 دقیقه بعد)
    schedule.every().day.at("08:32").do(send_btc_analysis) # تحلیل بیتکوین (1 دقیقه بعد)

    # پیام انگیزشی/آموزشی هر 90 دقیقه بعد از ساعت 13 ایران (09:30 UTC)
    schedule.every().day.at("09:30").do(send_educational_message)  # 13:00 ایران = 09:30 UTC
    for i in range(1, 8):  # تا 8 بار بعدش (12 ساعت)
        t = (9*60 + 30) + i*90  # دقیقه از نیمه شب UTC
        hour = t // 60
        minute = t % 60
        schedule.every().day.at(f"{hour:02d}:{minute:02d}").do(send_educational_message)

    while True:
        schedule.run_pending()
        time.sleep(10)